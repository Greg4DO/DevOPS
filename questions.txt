wi-fi: KmdsdTgfv
vm on 2012r2

AWS
1.EC2
User name	Administrator
Password	e.7fKrXbMx	Kg7cYQx35X	&jW;JS552y


1. updates 1 в три дня в 15-00. ставить но не перегружать. ставить c mydomain.com
2. в чем разница между full и modify permissions.
	full - доступ c возможностью изменять права и правила аудита к папкам и файлам
3. calc.exe зарегить как сервис и запустить от отличного от local system пользователя. (sc in PS)
	sc create CalcService Displayname="CalcService" binpath="C:\Windows\system32\calc.exe"
4. почему мало сделать export registry.
	пропадают права
5. как востановить права на ветку CurrentControlSet
	backup: subInACL /noverbose /output=C:\T\Software.txt /subkeyreg HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet /display=sddl
	restore: subInACL /playfile C:\T\Software.txt

kernel mode -> services
user mode -> programs


AD objects: Ресурси, служби, облікові записи
Forest, Tree





2 DCs + ports currpot

user1 user2
group1 group2

user1 - group1, users
user2- group2, rdusers, users

200 MB new disk copy C:\Work to disk D with permissions

термін дії паролю 3 дні
disable enforce password
rdp лишити але доступу нема


C:\Work\ file1 file2
file1 - user1
file2 -user2




53, 80, 88, 135, 389, 636
53.88.123

load balancing also used like port forwarding


new user in domain
start calc run as from new user

change data by duser
runas /user:devopslabs\duser "control C:\Windows\System32\timedate.cpl"
time 14:00

install IIS

bindings: IP, Name, Port


new FTP site
1 local 1domain user folders
upload and download files



FTP Site 2 users 1domain 1local
2 web site 1site from local 1 from domain user
html calc.exe
C:TempLocal C:TempDomain
Security for site
2 app  ploos from Network Service account
upload from dc


!!!Conditional forwarders
Zone (google.com) -> DNS who knows where (8.8.8.8)

Delegation control
DNS Server who can manage my Zone



begin tran t1;
select * from table;
update table set id=33 where name=alan;
commit/rollback;


Create login, create db, create table (id,name,value)
insert 20000 random entries
Set db maxsize 20 Mb
Set CP1252 collation on instance

Додати ключ в реєстрі через cmd
REG ADD HKLM\Software\MyCo
REG ADD HKLM\Software\MyCo /v Data /t REG_BINARY /d fe340ead
REG ADD HKLM\Software\MyCo /v MRU /t REG_MULTI_SZ /d fax\0mail\0\0
REG ADD HKLM\Software\MyCo /v Path /t REG_EXPAND_SZ /d ^%systemroot^%
REG DELETE HKLM\Software\MyCo


ODBC

HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\





DevOps 
Developer - Build - Test - Deploy - Client
Build - Test - Deploy -> DevOps
Operations - internal (кухня)
Service - external (офіціант)
CI/CD (Continous Integration, Continous Delivery/Deployment)
CI - зібрати збірку (збілдати), відтестувати
CDeployment - впровадження оновлень в мінімальний час простою сервісу.
CDelivery - всі ці елементи впроваджувати в мінімальний час максимально автоматизовано.
CM (Configuration Management) - HardWare (System Administration), virtualization, cloud, Orchestration(tools for virtualization (Chef, Puppet, Ansible, Vagrant)), Automation.

chroot - юзер не зможе вийте вище директорією

File System
/tmp - sticky bit, чиститься після ребуту - temporary files
/etc - config files
/bin - user binaries
/sbin - system binaries
/dev - device files
/proc - proccess information, можна напряму звертатись до процесів, єдиний шлях відновити щойно вбитий файл
/var - variable files
/usr - user programs
/home - home dirictories
/boot - bott loader files
/lib - system libraries
/opt - otional add-ons
/mnt- mount directory
/media - removable devices
/srv - service data
/sys - несконфігуровані пристрої

File types
file, directory, link, charachter device, block device, sockets, pipline
inodes - вся інформація про файли, ім’я знаходиться в каталозі.
soft link - може посилатись на зовнішню файлову систему, можна посилатись на каталог, нічого не говорить про атрибути оригінального файлу і його права.
hard link - друге ім’я файлу, не мапиться на каталог чи на зовнішній девайс
block device - disks, network (напряму звертатись не можем)
charachter device - dev/tti, dev/con, dev/zero, dev/urandom, 
Перехід між блочним пристроєм і файлом - команда dd
pipeline - канали вводу/виводу даних (stdout/stdin)
socket - програмний канал, в основному використовується для мереж //xinetd (запуск програми по зверненню до порта)

SSH
Remote console (on server install sshd, credentials, shell, port) /etc/passwd
Remote copy (scp, rsync) (scp /tmp/test copy to user@host:/dir)
Remote execution (ssh user@host "command")
Port forwarding (local port forward to remote port) (ssh reverse proxy)
Tunneling пов’язано з PF
Authorization mechanism (паролями, ключами) public key - замок, secret - ключ, passphrase - шифрування ключа паролем; утиліта ssh-keygen; з secret можна відновити public; (локально треба мати каталог .ssh з правами 500, всередині файл id_rsa з правами 400) ; ssh -vvvv
Ready for subsystems  
config file /etc/ssh/ssh.config


home task: install Vagrant(репозиторій VagrantBox, також є на GitHub), install Centos_64 on virtualbox, install Ansible, create knowledge base (KB) in cloud, GitHub, putty
Згенерувати ключ і підключитись ним по ssh
Файл /home/user/.ssh/Authorized keys

man ssh
w - connections to host

Vbox vagrant - Ubuntu, CentOS
AWS - Ubuntu(ssh port 22055)
Access to AWS Ubuntu from Vbox via ssh
on Vbox ssh port forwarding to AWS; from Internet connect to AWS and forward to Vbox


vagrant status
vagrant ssh

reverse channel:
remote to server
cat .ssh/id_rsa.pub >> .ssh/authorized_keys
ssh root@localhost //test is it possible
ssh -D 8899 root@localhost //dynamicaly port forward (comes from any port to 8899)
ssh root@server
ssh 5555:localhost:8899 root@server //

Check Sylinux on CentOS

User information in /etc/passwd
/etc/shadow
/etc/groups
пароль групи потрібен для того щоб комусь дати, щоб він зміг додати ще людей в групу
usermod -aG
id

Permissions on folders
execute (1) - only enter folder, you can get file in that folder only if you know its name
read and execute (3) - enter folder and list files
read write execute (7) - enter folder list files write files, couldn't delete this folder; you can delete this folder only from parent permissions

Permissions on files
make executable files with execution bit
if copy executable file from remote system it drop executable on local system

umask -утиліта яка регулює права по дефолту
для файлу від 666 віднімається якесь значення (666-033=644) побітово!!!!
для папки від 777 віднімається якесь значення (777-033=744) побітово!!!!

0444
0 - 3 біти suid sgid sticky
suid - в момент запуску програми, програма набуває прав власника файла (тільки для executables файлів); passwd - власник root права 755, цій програмі треба записати в shadow. При запуску від звичайного юзера далі passwd виконується з-під root.
sgid - в момент запуску програми, програма набуває прав власника групи (для папок)
sticky - ставиться на файли, видалити які може тільки власник. Наприклад каталог tmp

Утиліта ACL при загрузці файлової системи

useradd usermod userdel
userdel -rf (видаляються і юзер і home і пошта)

su login (login as root)
sudo command (run command as root)
visudo - sudo config file

mkdir /tmp/xxx
cd !$
result: cd /tmp/xxx

history
!номер_команди (!35)

в bashrc можна дописати в history час

ctrl+U delete left part of command
ctrl+K delete right part of comand

hometask:
створити користувача з папкою і файлами
різниця між r і rx
дати sguid 
написати програму cat /etc/shadow > /tmp/test/1.txt
1.txt - suid permissions
test - sguid permissions


== HOMETASK LESSON 2 ==
SSH port forward:
1. Buld SSH-tunel using Local port forward:  You should create connection from your local system to AWS instance and make socks-proxy on it using  dynamic port forward. (Note, thank you should run ssh twice)

sudo ssh -L 123:localhost:22 ubuntu@ec2-52-36-100-89.us-west-2.compute.amazonaws.com -i "./.ssh/AWS_key1.pem"

2. Build SSH-tunel using Remote port forward: You should create connection from AWS instance to your local VM which have only outgoing access allowed.

On local VM: ssh -i "id_rsa" ubuntu@ec2-52-36-100-89.us-west-2.compute.amazonaws.com -R 22055:localhost:22

7. Install and try "screen" terminal multiplexor ( yum install screen)
screen -S TOP
top
Ctrl+a+d
screen -ls
screen -r TOP (single user)
screen -x TOP (multiple users)

== HOMETASK LESSON 3 ==
3. How to pass password to sudo
echo <password> | sudo -S <command>

В sudoers можна прописати програму з якою може працювати користувач. (Програмідати root).
Якщо дати перед командою пробіл вона не запишеться в history.
history -c 140 видаляє 140 рядок з history.
passwd -d видаляє пароль користувачу.


DIRECTORY NAVIGATING

./ current dir
~/ home dir
/ root
../ parent dir
$0 де запущена програма
cd  go to home dir
cd- previos dir
pushd кидає в стек поточний каталог
popd переходить в поточний каталог

FILE MANAGEMENT

ls
find купа ключів (/ як далеко шукати; test фільтр; report ; -delete видаляє те що знайшло; -exec запускає команду знайденого файлу)
grep
locate шукає по буферу

cp
mv
rm
cp && rm
ключі -R(рекурсивно) -f(force) -i

rsync утиліта для копіювання каталогів/прав
rsync -e 'ssh' (може працювати через ssh на external системі)
rsync -av
rsync src/ dst not the same as src dst

touch створити файл
sed
mkdir
file виводить інфо про файл
stat виводить статистику про файл
basename виводить ім'я файлу
dirname виводить ім'я папки
realpath якщо треба добратись до файлу за лінком

chown зміна власника
chmod зміна прав
chmod 755 or chmod u+x (ugoa xrw)

md5sum * контрольна сума всіх файлів в поточному каталозі
md5sum >sum.txt
md5sum -c sum.txt порівнює файл з сумами у файлі sum.txt

diff порівняння файлів звичайних
cmp порівняння файлів бінарних

всі команди мають exit коди (&& якщо exit код 0; || якщо exit код не 0)

cat -A виводить всі недруковані символи

head n - перші n стрічок з файлу
tail n - останні n стрічок з файлу
tail -f - на екрані виводить дописування в файл

grep
	-i ігнорить casesensitive
	-v інверсія (виводить все крім того що зазначено)
	-A after
	-B before
	-R шукає по структурі директорій
	-o повертає тільки входження (ocurance)

'' строгі
"" нестрогі

ls -la | grep '^d' шукає всі файли що починаються на d
	      '$d'		      закінчується на d

.*
.+
.?
[0-9][a-z][A-Z] [A-Za-z0-9]


sed редактор який редагує файли на льоту зі скриптів
cat file | sed 's/що міняти/на що поміняти/g' де g всі входження, якщо без g то перше входження
можна замість / використовувати будь-який символ після s

awk редактор як sed але заточений на поля (таблиці)

cut ріже стрічку по полям
cut d, -f (d деліметром є кома)
коли деліметр є пробіл: cut d\  -f

tr 'що поміняти' 'на що поміняти'
tr -d 'що видалити'
tr -dc 'що залишити'
tr -s ' ' видаляє входження більше одного пробіла

sort - сортує файл
uniq - видає значення скільки було входжень
cat ufw.log |sed -e 's/SRC=/~/' -e 's/ DST=/~'|cut -d~ -f2 |sort -n|uniq -c| sort -nr -k1,8|head -30

hometask
вивести користувачів які не мають пароля
з якого адреса конектились
скільки типів файлів в системі
скільки файлів з нульовим об'ємом
скільки проців в системі і скіль в кожного потоків
змодифікувати файл hosts (дописати), перевірити чи вже існує


File Systems/Disks

fdisk -l показує підмонтовані диски в системі
LVM ріже логічний диск на піддиски для видачі їх віртуальним машинам
parted - утиліта розбивки дисків якщо диск більше 1 Тб?
parted -print показує підмонтовані диски в системі

cat /boot/grub/grub.cfg
/etc/fstab	/etc/mtab - всі змонтовані девайси
mount -l
mount -t v_fat /dev/sdf /mnt/usb
mount -t iso9600 /dev/cd /mnt/cd-rom
df-h
cat /proc/cpuinfo інфа про процесор в файловій системі proc
fsck - утиліта чекання і виправлення диску (не можна запускати на примонтованій файловій системі)
fsck -n перевіряє але не виправляє
mkfs - створює файлову систему
NFS - можна примонтувати файлову систему з мережі
по ssh також можна примонтувати ФС
posix
glusterfs - надбудова над стандартними ext2 ext3 (робить RAID з дисків на різних машинах)
ext3 відрізняється від ext2 тим що ext3 - журнальована файлова система
dd - копіювання фізичних дисків
dd if=/path/to/input of=/path/to/output
rsync - копіює тільки нові або змінені файли
диск віртуальної машини можна підмонтувати як readonly

systemd - первинний процес
 https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/chap-Managing_Services_with_systemd.html

процесу можна подати сигнал
kill -n де n - сигнал [1-15]
-9 витирає все з пам'яті
-15 нормальне завершення (нові підключення заборонені, чекає завершення існуючих підключень)

top
ps тільки процеси поточного юзера
ps -aux всі процеси
ps -aux | grep sshd | grep vagrant | grep -v root | xagrs kill -9
lsof всі відкриті файли(якщо треба дізнатися який файл відкрив процес)
послати в бекграунд
vi tmp.txt &
повернути з бекграунду (якщо один процес)
fg
якщо багато процесів
jobs повертає список процесів в бекграунді

w - залоговані юзери в системі
watch 'command' - обновляє результат вказаної команди кожні 2 секунди
watch 'w'

loop device - Коли треба підмонтувати файл як диск

LVM
pv - phisical volume (не sda а sda1)
vg - volume group 
lv - logical volume (LUN)
LVM have snapshots
If phisical disk bad, add new PV, then PV move from bad to new, then remove bad phisical disk.

hdparm -tT /dev/sda1 перевірка швидкості диска
time <program> скільки часу треба було на запуск проги, скільки вона відпрацьовувала, коли завершилась

hometask:
1.losetup: dd flash disk to img. losetup img and mount as disk.


NETWORK

OSI Model
1. Phisical (код Морзе)
2. Data Link (зв'язок по MAC-адресам; роутери)
3. Network (протоколи IP, ICMP)
arp - коли девайс питає хто має таку IP, хтось кже я і ця IP відповідаю такому MAC.
           xxx.xxx.xxx.xxx
                  |  
network addresses | host addresses
4. Transport (TCP,UDP)
5. Session (встановлення сесії; SSL(перевірка сертифікату),RPC,SQL,NFS,NetBIOS)
6. Presentation (Syntax layer; SSL (шифрування каналу))
7. Application(User Applications)

1.
lshw      |
lsusb     |
lspci     | фізичні пристрої системи
dmidecode |
iwlist    |

2.
iwconfig утиліта конфігурування wi-fi карти
ethtool утиліта міняє параметри мережевої карти
arp (наприклад для тестування роботи DHCP) дозволяє визначити MAC-адресу машин
arpping

3.
ping
traceroute
ttl скільки хостів може пройти пакет, перед тим як вмерти
mtu розмір пакету

4.
iproute (ifconfig, netstat, ...)
iproute2 (ip, ss, ts) ip a всі інтерфейси на машині; ip r всі роути на машині
ip address
ip route
netstat є нова ss
ss -anal
ss -nlp
ts обмежує швидкість на інтерфейсі


FIREWALL
Stateless and Statefull firewalls
iptables statefull firewall
inbound,outbaont, and forward packets
Ebtables has three tables: filter, nat, broute
Chains - набір правил в таблицях
В таблиці filter є 3 стандартних чейна: INPUT, OUTPUT, FORWARD

Дуже спрощено приклад правила:
iptables -t filter

iptables -A INPUT -p tcp -s 1.2.3.4 -j DROP
iptables -A INPUT -p tcp -s 1.2.3.0/24 -j ACCEPT
iptables -A INPUT -p tcp -port 80 -j ACCEPT
iptables -A INPUT -p tcp -port 22 -j ACCEPT
iptables -A INPUT -p tcp -j DROP

iptables -S зберігає всі нові правила

Щоб дозволити доступ всередині машини
iptables -A INPUT -o lo -j ACCEPT

iptables -P Якщо пакет не підпав під жодне правило
iptables -P INPUT -j DROP

-I (як -A) вставляє правило в перший рядок

iptables -L Подивитись всі правила

В убунті є свій врапер для фаєрвола UFW

ufw status подивитись всі правила

Правила NAT обробляються перед правилами FILTER
DNAT в таблиці PREROUTING
SNAT в таблиці POSTROUTING
MASQUARADE в таблиці POSTROUTING

Щоб дозволити FORWARD пакетів В /etc/sysctl.conf увімкнути net.ipv4.ip_forward=1

hometask:
командою ір підняти логічний інтерфейс на фізичному
man ip
iptables
підняти на двух машинах внутрішню мережу. одна роутер з двома інтерфейсами, сконфіжити нат, сконфіжити пакет форвард, сконфіжити фаєрвол, інтерфейс зовнішній - брідж. з другої машини ходити в інтернет через першу.


SCRIPTING

Перенаправлення і конвеєрезація
Дискриптори вводу і виводу
stdin (0) stdout (1) stderr (2)

Як вивести тільки помилки, коли ми шукаємо в рут-директорії:
find / 1>/dev/null

Помилки в один файл, добре в другий:
ls -la /var/lib/* 2>/tmp/err 1>/tmp/ok

du 2>/dev/null | sort -nr -kl,8 | head -30

Перенаправити все &>
duv &>/dev/null

Щоб направити задачу в бекграунд, після команди писати &
find / 2>/dev/null &

показати останню команду:
!!

Щоб ловити коди відпрацювання команд
&&
Якщо команда виконалась з кодом 0 то вивести ОК
ping 8.8.8.8 && echo OK


Щоб в одній стрічці вказати дві команди ;
echo A ; echo B
cp a b ; rm a

Якщо код не 0 ||
ping 8.8.8.8 && echo OK || echo NO

Підстановка змінної:
HOST=8.8.8.8 ; ping ${HOST} && echo OK || echo NO

Все що поміститься в () виконається як в окремому шеллі
echo "$(date -R)" >> /tmp/test.txt ; cat /tmp/test.txt ; ls -la /tmp/te*

Включити відладчик
set -x

Виключити відладчик
set +x

echo "$(ls /tmp/$(echo t)*)"

mkdir /tmp/$(date +%Y)

Перевірка чи є директорія
[ -d /tmp/$(date +%Y) ] && echo Y || mkdir /tmp/$(date +%Y)

man test

Якщо в команді вказати -p помилка не видасться

Як створити 100 папок
mkdir /tmp/{1..100}

for host in 192.168.1.{1..100} ; do ping $host && $host ; echo -UP || $host ; echo -DOWN

Обрахунок
echo $((2+5))
